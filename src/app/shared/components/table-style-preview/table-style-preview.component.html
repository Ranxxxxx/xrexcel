<mat-card class="settings-card">
  <mat-card-header>
    <mat-card-title>
      <div class="title-container">
        <div class="title-content">
          <mat-icon class="header-icon">palette</mat-icon>
          表格风格设置
        </div>
        @if (showResetButton()) {
          <button mat-button
                  class="reset-button"
                  (click)="onResetToDefault()"
                  color="primary">
            <mat-icon>refresh</mat-icon>
            重置外观
          </button>
        }
      </div>
    </mat-card-title>
    <mat-card-subtitle>自定义表格的外观样式和格式</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="settings-container">
      <mat-expansion-panel class="settings-section">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>style</mat-icon>
            基础样式
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="settings-grid">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>表格风格</mat-label>
            <mat-select [value]="tableStyle().style" (selectionChange)="updateStyle('style', $event.value)">
              @for (style of styleOptions; track style) {
                <mat-option [value]="style">{{ style }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>字体选择</mat-label>
            <mat-select [value]="tableStyle().fontFamily" (selectionChange)="updateStyle('fontFamily', $event.value)">
              @for (font of fontOptions; track font) {
                <mat-option [value]="font">{{ font }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </mat-expansion-panel>

      <mat-expansion-panel class="settings-section">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>color_lens</mat-icon>
            背景颜色设置
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="settings-grid">
          <div class="color-setting">
            <mat-form-field appearance="outline">
              <mat-label>标题栏背景颜色</mat-label>
              <input matInput type="text" [value]="tableStyle().titleColor" (input)="updateStyle('titleColor', $any($event.target).value)">
            </mat-form-field>
            <input type="color" [value]="tableStyle().titleColor" (change)="updateStyle('titleColor', $any($event.target).value)" class="color-picker">
          </div>

          <div class="color-setting">
            <mat-form-field appearance="outline">
              <mat-label>表头背景颜色</mat-label>
              <input matInput type="text" [value]="tableStyle().headerColor" (input)="updateStyle('headerColor', $any($event.target).value)">
            </mat-form-field>
            <input type="color" [value]="tableStyle().headerColor" (change)="updateStyle('headerColor', $any($event.target).value)" class="color-picker">
          </div>

          <div class="color-setting">
            <mat-form-field appearance="outline">
              <mat-label>合计背景颜色</mat-label>
              <input matInput type="text" [value]="tableStyle().totalColor" (input)="updateStyle('totalColor', $any($event.target).value)">
            </mat-form-field>
            <input type="color" [value]="tableStyle().totalColor" (change)="updateStyle('totalColor', $any($event.target).value)" class="color-picker">
          </div>

          <div class="color-setting">
            <mat-form-field appearance="outline">
              <mat-label>边框颜色</mat-label>
              <input matInput type="text" [value]="tableStyle().borderColor" (input)="updateStyle('borderColor', $any($event.target).value)">
            </mat-form-field>
            <input type="color" [value]="tableStyle().borderColor" (change)="updateStyle('borderColor', $any($event.target).value)" class="color-picker">
          </div>
        </div>
      </mat-expansion-panel>

      <mat-expansion-panel class="settings-section">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>text_fields</mat-icon>
            字体设置
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="settings-grid">
          <div class="font-setting">
            <mat-form-field appearance="outline">
              <mat-label>标题字体大小</mat-label>
              <mat-select [value]="tableStyle().titleFontSize" (selectionChange)="updateStyle('titleFontSize', $event.value)">
                @for (size of fontSizeOptions; track size) {
                  <mat-option [value]="size">{{ size }} 号</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-checkbox [checked]="tableStyle().titleFontBold" (change)="updateStyle('titleFontBold', $event.checked)">
              加粗
            </mat-checkbox>
            <div class="color-setting-inline">
              <mat-form-field appearance="outline" class="color-input-small">
                <mat-label>标题颜色</mat-label>
                <input matInput type="text" [value]="tableStyle().titleFontColor" (input)="updateStyle('titleFontColor', $any($event.target).value)">
              </mat-form-field>
              <input type="color" [value]="tableStyle().titleFontColor" (change)="updateStyle('titleFontColor', $any($event.target).value)" class="color-picker-small">
            </div>
          </div>

          <div class="font-setting">
            <mat-form-field appearance="outline">
              <mat-label>表头字体大小</mat-label>
              <mat-select [value]="tableStyle().headerFontSize" (selectionChange)="updateStyle('headerFontSize', $event.value)">
                @for (size of fontSizeOptions; track size) {
                  <mat-option [value]="size">{{ size }} 号</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-checkbox [checked]="tableStyle().headerFontBold" (change)="updateStyle('headerFontBold', $event.checked)">
              加粗
            </mat-checkbox>
            <div class="color-setting-inline">
              <mat-form-field appearance="outline" class="color-input-small">
                <mat-label>表头颜色</mat-label>
                <input matInput type="text" [value]="tableStyle().headerFontColor" (input)="updateStyle('headerFontColor', $any($event.target).value)">
              </mat-form-field>
              <input type="color" [value]="tableStyle().headerFontColor" (change)="updateStyle('headerFontColor', $any($event.target).value)" class="color-picker-small">
            </div>
          </div>

          <div class="font-setting">
            <mat-form-field appearance="outline">
              <mat-label>数据字体大小</mat-label>
              <mat-select [value]="tableStyle().dataFontSize" (selectionChange)="updateStyle('dataFontSize', $event.value)">
                @for (size of fontSizeOptions; track size) {
                  <mat-option [value]="size">{{ size }} 号</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-checkbox [checked]="tableStyle().dataFontBold" (change)="updateStyle('dataFontBold', $event.checked)">
              加粗
            </mat-checkbox>
            <div class="color-setting-inline">
              <mat-form-field appearance="outline" class="color-input-small">
                <mat-label>数据颜色</mat-label>
                <input matInput type="text" [value]="tableStyle().dataFontColor" (input)="updateStyle('dataFontColor', $any($event.target).value)">
              </mat-form-field>
              <input type="color" [value]="tableStyle().dataFontColor" (change)="updateStyle('dataFontColor', $any($event.target).value)" class="color-picker-small">
            </div>
          </div>
        </div>
      </mat-expansion-panel>

      <mat-expansion-panel class="settings-section">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>border_style</mat-icon>
            边框设置
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="settings-grid">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>边框样式</mat-label>
            <mat-select [value]="tableStyle().borderStyle" (selectionChange)="updateStyle('borderStyle', $event.value)">
              @for (style of borderStyleOptions; track style.value) {
                <mat-option [value]="style.value">{{ style.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </mat-expansion-panel>
    </div>
  </mat-card-content>
</mat-card>

@if (showPreview()) {
<mat-card class="preview-card">
  <mat-expansion-panel [expanded]="previewExpanded()" (opened)="onPreviewExpandedChange(true)" (closed)="onPreviewExpandedChange(false)">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon class="header-icon">preview</mat-icon>
        预览区域
      </mat-panel-title>
      <mat-panel-description>
        @if (previewData().length > 0 && previewData()[1] && previewData()[1].length > 0) {
          实时预览表格数据和样式效果
        } @else {
          示例预览（选择 Excel 文件后将显示实际数据）
        }
      </mat-panel-description>
    </mat-expansion-panel-header>
    <div class="preview-container">
      <div class="preview-table-wrapper">
        @if (previewData().length > 0) {
          <table class="preview-table" [style.font-family]="tableStyle().fontFamily">
            <thead>
              <!-- 标题行 -->
              @if (previewData()[0]) {
                <tr class="title-row">
                  <td [attr.colspan]="previewData()[1]?.length || 4"
                      [style.background-color]="tableStyle().titleColor"
                      [style.color]="tableStyle().titleFontColor"
                      [style.font-size.px]="tableStyle().titleFontSize * 1.5"
                      [style.font-weight]="tableStyle().titleFontBold ? 'bold' : 'normal'"
                      [style.border]="getBorderStyle()"
                      [style.border-color]="tableStyle().borderColor"
                      [style.text-align]="'center'">
                    {{ previewData()[0]?.[0] || '示例表格标题' }}
                  </td>
                </tr>
              }
              <!-- 表头行 -->
              @if (previewData()[1]) {
                <tr class="header-row">
                  @for (header of previewData()[1]; track $index) {
                    <th [style.background-color]="tableStyle().headerColor"
                        [style.color]="tableStyle().headerFontColor"
                        [style.font-size.px]="tableStyle().headerFontSize * 1.2"
                        [style.font-weight]="tableStyle().headerFontBold ? 'bold' : 'normal'"
                        [style.border]="getBorderStyle()"
                        [style.border-color]="tableStyle().borderColor">
                      {{ header }}
                    </th>
                  }
                </tr>
              }
            </thead>
            <tbody>
              <!-- 数据行 -->
              @for (row of previewData().slice(2, -1); track $index) {
                <tr>
                  @for (cell of row; track $index) {
                    <td [style.color]="tableStyle().dataFontColor"
                        [style.font-size.px]="tableStyle().dataFontSize"
                        [style.font-weight]="tableStyle().dataFontBold ? 'bold' : 'normal'"
                        [style.border]="getBorderStyle()"
                        [style.border-color]="tableStyle().borderColor">
                      {{ cell }}
                    </td>
                  }
                </tr>
              }
              <!-- 合计行 -->
              @if (previewData().length > 0 && previewData()[previewData().length - 1]) {
                <tr class="total-row">
                  @for (cell of previewData()[previewData().length - 1]; track $index) {
                    <td [style.background-color]="tableStyle().totalColor"
                        [style.color]="tableStyle().dataFontColor"
                        [style.font-size.px]="tableStyle().dataFontSize"
                        [style.font-weight]="tableStyle().dataFontBold ? 'bold' : 'normal'"
                        [style.border]="getBorderStyle()"
                        [style.border-color]="tableStyle().borderColor">
                      {{ cell }}
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        } @else {
          <div class="preview-placeholder">
            <mat-icon>table_chart</mat-icon>
            <p>请先选择 Excel 文件</p>
          </div>
        }
      </div>
    </div>
  </mat-expansion-panel>
</mat-card>
}


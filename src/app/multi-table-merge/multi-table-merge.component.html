<div class="page-container">
  <mat-toolbar color="primary" class="page-toolbar">
    <button mat-icon-button [routerLink]="'/'">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="toolbar-title">多表格数据合并</span>
    <span class="spacer"></span>
    <mat-icon>merge_type</mat-icon>
  </mat-toolbar>

  <div class="page-content">
    <app-table-style-preview
      [tableStyle]="tableStyle()"
      [previewData]="previewData()"
      [previewExpanded]="previewExpanded()"
      [showResetButton]="showResetButton()"
      [showPreview]="false"
      (styleChange)="updateStyle($event.key, $event.value)"
      (previewExpandedChange)="previewExpanded.set($event)"
      (resetToDefault)="resetTableStyleToDefault()">
    </app-table-style-preview>

    <mat-card class="content-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon class="header-icon">description</mat-icon>
          内容区域
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-stepper [linear]="true" #stepper>
          <!-- Step 1: 选择文件 -->
          <mat-step>
            <ng-template matStepLabel>选择文件</ng-template>
            <div class="step-content">
              <div class="upload-files-container">
                <!-- 左侧：基础文件 -->
                <div class="upload-file-section">
                  <h4 class="section-title">
                    <mat-icon>folder</mat-icon>
                    基础文件
                  </h4>
                  <app-file-upload
                    [selectedFile]="baseFile()"
                    [isUploading]="isUploadingBaseFile()"
                    (fileSelected)="onBaseFileSelected($event)">
                  </app-file-upload>
                </div>
                <!-- 右侧：数据源 -->
                <div class="upload-file-section">
                  <h4 class="section-title">
                    <mat-icon>data_object</mat-icon>
                    数据源
                  </h4>
                  <app-file-upload
                    [selectedFile]="dataSourceFile()"
                    [isUploading]="isUploadingDataSourceFile()"
                    (fileSelected)="onDataSourceFileSelected($event)">
                  </app-file-upload>
                </div>
              </div>
              @if (canProceedToStep2()) {
                <div class="step-actions">
                  <button mat-raised-button color="primary" (click)="stepper.next()">
                    下一步
                    <mat-icon>arrow_forward</mat-icon>
                  </button>
                </div>
              }
            </div>
          </mat-step>

          <!-- Step 2: 设置合并目标 -->
          <mat-step>
            <ng-template matStepLabel>设置合并目标</ng-template>
            <div class="step-content">
              <div class="merge-target-container">
                <!-- 左侧：基础文件sheet选择 -->
                <div class="merge-target-section">
                  <h4 class="section-title">
                    <mat-icon>folder</mat-icon>
                    基础文件Sheet
                  </h4>
                  <p class="section-description">选择需要合并的Sheet（可多选）：</p>

                  <!-- 多选下拉框 -->
                  <mat-form-field appearance="outline" class="sheet-select-field">
                    <mat-label>选择Sheet</mat-label>
                    <mat-select
                      [value]="selectedBaseSheets()"
                      (selectionChange)="onBaseSheetsSelectionChange($event.value)"
                      multiple>
                      <!-- 全选选项 -->
                      <mat-option (click)="$event.stopPropagation(); toggleSelectAllBaseSheets()" class="select-all-option">
                        <mat-checkbox
                          [checked]="isAllBaseSheetsSelected()"
                          [indeterminate]="selectedBaseSheets().length > 0 && !isAllBaseSheetsSelected()"
                          (click)="$event.stopPropagation()">
                        </mat-checkbox>
                        <span>全选</span>
                      </mat-option>
                      <mat-divider></mat-divider>
                      <!-- Sheet选项 -->
                      @for (sheetName of baseSheetNames(); track sheetName) {
                        <mat-option [value]="sheetName">
                          {{ sheetName }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  @if (selectedBaseSheets().length > 0) {
                    <div class="selected-count">
                      已选择 {{ selectedBaseSheets().length }} 个Sheet
                    </div>
                    <div class="header-row-input">
                      <mat-form-field appearance="outline">
                        <mat-label>表头所在行数</mat-label>
                        <input
                          matInput
                          type="number"
                          [value]="baseHeaderRow()"
                          (input)="baseHeaderRow.set(+($any($event.target).value))"
                          (change)="onBaseHeaderRowChange()"
                          min="1">
                      </mat-form-field>
                    </div>

                    <!-- 显示表头 -->
                    @if (baseHeaders().length > 0) {
                      <div class="headers-display-section">
                        <p class="section-description">选择需要合并的表头（可多选）：</p>
                        <div class="headers-chips-container">
                          @for (header of baseHeaders(); track header) {
                            <mat-chip
                              [class.selected]="selectedHeaders().includes(header)"
                              (click)="toggleHeader(header)">
                              @if (selectedHeaders().includes(header)) {
                                <mat-icon>check</mat-icon>
                              }
                              {{ header }}
                            </mat-chip>
                          }
                        </div>
                      </div>
                    }
                  }
                </div>

                <!-- 右侧：数据源sheet选择 -->
                @if (shouldShowDataSourceSection()) {
                  <div class="merge-target-section">
                    <h4 class="section-title">
                      <mat-icon>data_object</mat-icon>
                      数据源Sheet
                    </h4>
                    <p class="section-description">选择数据源Sheet（可多选）：</p>

                    <!-- 多选下拉框 -->
                    <mat-form-field appearance="outline" class="sheet-select-field">
                      <mat-label>选择Sheet</mat-label>
                      <mat-select
                        [value]="selectedDataSourceSheets()"
                        (selectionChange)="onDataSourceSheetsSelectionChange($event.value)"
                        multiple>
                        <!-- 全选选项 -->
                        <mat-option (click)="$event.stopPropagation(); toggleSelectAllDataSourceSheets()" class="select-all-option">
                          <mat-checkbox
                            [checked]="isAllDataSourceSheetsSelected()"
                            [indeterminate]="selectedDataSourceSheets().length > 0 && !isAllDataSourceSheetsSelected()"
                            (click)="$event.stopPropagation()">
                          </mat-checkbox>
                          <span>全选</span>
                        </mat-option>
                        <mat-divider></mat-divider>
                        <!-- Sheet选项 -->
                        @for (sheetName of dataSourceSheetNames(); track sheetName) {
                          <mat-option [value]="sheetName">
                            {{ sheetName }}
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>

                    @if (selectedDataSourceSheets().length > 0) {
                      <div class="selected-count">
                        已选择 {{ selectedDataSourceSheets().length }} 个Sheet
                      </div>
                      <div class="header-row-input">
                        <mat-form-field appearance="outline">
                          <mat-label>表头所在行数</mat-label>
                          <input
                            matInput
                            type="number"
                            [value]="dataSourceHeaderRow()"
                            (input)="dataSourceHeaderRow.set(+($any($event.target).value))"
                            (change)="onDataSourceHeaderRowChange()"
                            min="1">
                        </mat-form-field>
                      </div>

                      <!-- 显示表头 -->
                      @if (dataSourceHeaders().length > 0) {
                        <div class="headers-display-section">
                          <p class="section-description">选择需要合并的表头（可多选）：</p>
                          <div class="headers-chips-container">
                            @for (header of dataSourceHeaders(); track header) {
                              <mat-chip
                                [class.selected]="selectedHeaders().includes(header)"
                                (click)="toggleHeader(header)">
                                @if (selectedHeaders().includes(header)) {
                                  <mat-icon>check</mat-icon>
                                }
                                {{ header }}
                              </mat-chip>
                            }
                          </div>
                        </div>
                      }
                    }
                  </div>
                }
              </div>

              <!-- 表头排序区域 -->
              @if (shouldShowHeaderSortSection()) {
                <div class="header-sort-section">
                  <h4 class="section-title">
                    <mat-icon>sort</mat-icon>
                    表头排序
                  </h4>
                  <p class="section-description">已选择的表头（可拖拽排序，点击删除按钮移除）：</p>
                  <div class="header-chips-container" cdkDropList cdkDropListOrientation="mixed" (cdkDropListDropped)="dropHeader($event)">
                    @for (header of sortedHeaders(); track header; let i = $index) {
                      <mat-chip cdkDrag (removed)="removeHeaderFromSorted(header)">
                        {{ header }}
                        <button matChipRemove>
                          <mat-icon>cancel</mat-icon>
                        </button>
                      </mat-chip>
                    }
                  </div>
                </div>
              }

              <div class="step-actions">
                <button mat-button (click)="stepper.previous()">
                  <mat-icon>arrow_back</mat-icon>
                  上一步
                </button>
                @if (shouldShowHeaderSortSection()) {
                  <button mat-raised-button color="primary" (click)="stepper.next()">
                    下一步
                    <mat-icon>arrow_forward</mat-icon>
                  </button>
                }
              </div>
            </div>
          </mat-step>

          <!-- Step 3: 设置表尾功能 -->
          <mat-step>
            <ng-template matStepLabel>设置表尾功能</ng-template>
            <div class="step-content">
              <div class="footer-functions-section">
                <h4 class="section-title">
                  <mat-icon>functions</mat-icon>
                  表尾功能配置
                </h4>
                <p class="section-description">为选中的表头配置合计或平均值功能：</p>

                <div class="footer-functions-config">
                  <mat-form-field appearance="outline" class="footer-type-field">
                    <mat-label>功能类型</mat-label>
                    <mat-select [value]="newFooterType()" (selectionChange)="newFooterType.set($event.value)">
                      <mat-option value="合计">合计</mat-option>
                      <mat-option value="平均值">平均值</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="footer-header-field">
                    <mat-label>选择表头</mat-label>
                    <mat-select [value]="newFooterHeader()" (selectionChange)="newFooterHeader.set($event.value)">
                      <mat-option value="">-- 请选择表头 --</mat-option>
                      @for (header of getAvailableHeadersForFooter(); track header) {
                        <mat-option [value]="header">{{ header }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  <button
                    mat-raised-button
                    color="primary"
                    (click)="addFooterFunction()"
                    [disabled]="!newFooterHeader()">
                    <mat-icon>add</mat-icon>
                    添加表尾功能
                  </button>
                </div>

                @if (footerFunctions().length > 0) {
                  <div class="footer-functions-list">
                    <p class="list-title">已配置的表尾功能：</p>
                    <div class="footer-functions-chips">
                      @for (footer of footerFunctions(); track footer.id) {
                        <mat-chip (removed)="removeFooterFunction(footer.id)">
                          <mat-icon class="footer-icon">{{ footer.type === '合计' ? 'calculate' : 'trending_up' }}</mat-icon>
                          {{ getFooterFunctionLabel(footer) }}
                          <button matChipRemove>
                            <mat-icon>cancel</mat-icon>
                          </button>
                        </mat-chip>
                      }
                    </div>
                  </div>
                }
              </div>

              <div class="step-actions">
                <button mat-button (click)="stepper.previous()">
                  <mat-icon>arrow_back</mat-icon>
                  上一步
                </button>
                <button mat-raised-button color="primary" (click)="stepper.next()">
                  下一步
                  <mat-icon>arrow_forward</mat-icon>
                </button>
              </div>
            </div>
          </mat-step>

          <!-- Step 4: 关联更新汇总表 -->
          <mat-step>
            <ng-template matStepLabel>关联更新汇总表</ng-template>
            <div class="step-content">
              <div class="update-summary-section">
                <h4 class="section-title">
                  <mat-icon>update</mat-icon>
                  是否更新汇总表
                </h4>
                <mat-radio-group [value]="updateSummaryTable() ? 'yes' : 'no'" (change)="updateSummaryTable.set($event.value === 'yes')">
                  <mat-radio-button value="yes" class="radio-option">
                    <span>是</span>
                  </mat-radio-button>
                  <mat-radio-button value="no" class="radio-option">
                    <span>否</span>
                  </mat-radio-button>
                </mat-radio-group>
              </div>

              @if (updateSummaryTable()) {
                <div class="summary-table-config">
                  <!-- 选择汇总表sheet -->
                  <div class="summary-sheet-section">
                    <h4 class="section-title">
                      <mat-icon>folder</mat-icon>
                      选择汇总表Sheet
                    </h4>
                    <mat-form-field appearance="outline" class="sheet-select-field">
                      <mat-label>选择Sheet</mat-label>
                      <mat-select
                        [value]="selectedSummarySheet()"
                        (selectionChange)="selectedSummarySheet.set($event.value); onSummarySheetChange()">
                        <mat-option value="">-- 请选择Sheet --</mat-option>
                        @for (sheetName of baseSheetNames(); track sheetName) {
                          <mat-option [value]="sheetName">
                            {{ sheetName }}
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  </div>

                  @if (selectedSummarySheet()) {
                    <!-- 表头行数设置 -->
                    <div class="summary-header-row-section">
                      <h4 class="section-title">
                        <mat-icon>view_headline</mat-icon>
                        表头设置
                      </h4>
                      <mat-form-field appearance="outline">
                        <mat-label>表头所在行数</mat-label>
                        <input
                          matInput
                          type="number"
                          [value]="summaryHeaderRow()"
                          (input)="summaryHeaderRow.set(+($any($event.target).value))"
                          (change)="onSummarySheetChange()"
                          min="1">
                      </mat-form-field>
                    </div>

                    <!-- 汇总表表头列表 -->
                    @if (summaryHeaders().length > 0) {
                      <div class="summary-headers-section">
                        <h4 class="section-title">
                          <mat-icon>list</mat-icon>
                          汇总表表头（可拖拽排序，点击删除按钮移除）
                        </h4>
                        <div class="header-chips-container" cdkDropList cdkDropListOrientation="mixed" (cdkDropListDropped)="dropSummaryHeader($event)">
                          @for (header of summaryHeaders(); track header) {
                            <mat-chip cdkDrag (removed)="removeSummaryHeader(header)">
                              {{ header }}
                              <button matChipRemove>
                                <mat-icon>cancel</mat-icon>
                              </button>
                            </mat-chip>
                          }
                        </div>
                      </div>
                    }

                    <!-- 新增表头 -->
                    <div class="add-header-section">
                      <mat-form-field appearance="outline">
                        <mat-label>新增表头</mat-label>
                        <input matInput [value]="newSummaryHeaderName()" (input)="newSummaryHeaderName.set($any($event.target).value)" placeholder="输入新表头名称" (keyup.enter)="addNewSummaryHeader()">
                        <button mat-icon-button matSuffix (click)="addNewSummaryHeader()" [disabled]="!newSummaryHeaderName().trim()">
                          <mat-icon>add</mat-icon>
                        </button>
                      </mat-form-field>
                    </div>

                    <!-- 关联功能 -->
                    @if (summaryHeaders().length > 0 && sortedHeaders().length > 0) {
                      <div class="header-mapping-section">
                        <h4 class="section-title">
                          <mat-icon>link</mat-icon>
                          表头关联
                        </h4>
                        <p class="section-description">选择汇总表表头和合并表表头进行关联，再次选择可取消关联：</p>
                        <div class="header-mapping-container">
                          <!-- 左侧：汇总表表头 -->
                          <div class="header-column summary-headers-column">
                            <h3 class="column-title">
                              <mat-icon>table_chart</mat-icon>
                              汇总表
                            </h3>
                            <div class="header-list-mapping">
                              @for (header of summaryHeaders(); track header) {
                                <div
                                  class="mapping-header-item"
                                  [class.selected]="isSummaryHeaderSelectedForMapping(header)"
                                  [class.mapped]="isSummaryHeaderMapped(header)"
                                  (click)="selectSummaryHeaderForMapping(header)"
                                  [attr.data-header-id]="'summary-' + header">
                                  <mat-chip [class.selected-chip]="isSummaryHeaderSelectedForMapping(header)" [class.mapped-chip]="isSummaryHeaderMapped(header)">
                                    {{ header }}
                                    @if (isSummaryHeaderMapped(header)) {
                                      <mat-icon class="link-icon">link</mat-icon>
                                    }
                                  </mat-chip>
                                </div>
                              }
                            </div>
                          </div>

                          <!-- 中间：连接线区域 -->
                          <div class="connection-area" #connectionArea>
                            @for (mapping of headerMappings() | keyvalue; track mapping.key) {
                              <div
                                class="connection-line"
                                [attr.data-summary]="mapping.key"
                                [attr.data-merged]="mapping.value">
                              </div>
                            }
                          </div>

                          <!-- 右侧：合并表选项（表头和表尾功能） -->
                          <div class="header-column merged-headers-column">
                            <h3 class="column-title">
                              <mat-icon>merge_type</mat-icon>
                              合并表
                            </h3>
                            <div class="header-list-mapping">
                              @for (option of getMergedTableOptions(); track option.id) {
                                <div
                                  class="mapping-header-item"
                                  [class.mapped]="isMergedTableOptionMapped(option.id)"
                                  [class.footer-option]="option.type === 'footer'"
                                  (click)="selectMergedTableOptionForMapping(option.id)"
                                  [attr.data-header-id]="'merged-' + option.id">
                                  <mat-chip [class.mapped-chip]="isMergedTableOptionMapped(option.id)">
                                    @if (option.icon) {
                                      <mat-icon class="footer-icon">{{ option.icon }}</mat-icon>
                                    }
                                    {{ option.label }}
                                    @if (isMergedTableOptionMapped(option.id)) {
                                      <mat-icon class="link-icon">link</mat-icon>
                                    }
                                  </mat-chip>
                                </div>
                              }
                            </div>
                          </div>
                        </div>

                        @if (headerMappings().size > 0) {
                          <div class="mapping-summary">
                            <p>已建立 {{ headerMappings().size }} 个关联：</p>
                            <div class="mapping-list">
                              @for (mapping of headerMappings() | keyvalue; track mapping.key) {
                                <div class="mapping-item">
                                  <span class="mapping-from">{{ mapping.key }}</span>
                                  <mat-icon>arrow_forward</mat-icon>
                                  <span class="mapping-to">{{ getMergedTableOptionLabel(mapping.value) }}</span>
                                  <button mat-icon-button (click)="removeMapping(mapping.key)" matTooltip="取消关联">
                                    <mat-icon>close</mat-icon>
                                  </button>
                                </div>
                              }
                            </div>
                          </div>
                        }
                      </div>
                    }
                  }
                </div>
              }

              <div class="step-actions">
                <button mat-button (click)="stepper.previous()" [disabled]="isProcessing()">
                  <mat-icon>arrow_back</mat-icon>
                  上一步
                </button>
                <button mat-raised-button color="primary" (click)="onComplete()" [disabled]="isProcessing()">
                  @if (isProcessing()) {
                    <mat-icon>hourglass_empty</mat-icon>
                  } @else {
                    <mat-icon>check</mat-icon>
                  }
                  @if (isProcessing()) {
                    处理中...
                  } @else {
                    完成
                  }
                </button>
              </div>
            </div>
          </mat-step>
        </mat-stepper>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- 确认对话框 -->
  <app-confirm-dialog
    [visible]="showConfirmDialog()"
    [fileName]="outputFileName()"
    [progress]="generationProgress()"
    [isProcessing]="isProcessing()"
    (fileNameChange)="outputFileName.set($event)"
    (close)="closeConfirmDialog()"
    (confirm)="startGeneration()">
  </app-confirm-dialog>
</div>
